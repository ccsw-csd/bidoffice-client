<p-toast position="top-center"></p-toast>
<div [formGroup]="filterForm" class="w-full flex flex-row pb-4" >
  <div class="w-full flex flex-row gap-4">
    <div class="flex flex-1 flex-column gap-2">
      <div class="flex flex-row gap-4">
        <span class="p-float-label flex flex-1">
          <input pInputText [(ngModel)]="offerSearch.client" field="field" formControlName="client" class="w-full">
          <label>Cliente</label>
        </span>
        <span class="p-float-label flex-1">
          <p-autoComplete [suggestions]="groupPerson" [forceSelection]="true" [showEmptyMessage]="true"
            [emptyMessage]="message" (completeMethod)="searchPerson($event)"
            (onSelect)="offerSearch.requestedBy = $event.value" field="field" appendTo="body"
            [showClear]="offerSearch.requestedBy" (onClear)="resetValueForm('requestedBy')"
            formControlName="requestedBy" [style]="{'width':'100%'}" [inputStyle]="{'width':'100%'}">
          </p-autoComplete>
          <label>Comercial</label>
        </span>

        <span class="p-float-label w-15rem">
          <p-dropdown [(ngModel)]="offerSearch.sector" [options]="sectors" optionLabel="name" appendTo="body"
            [showClear]="true" formControlName="sector" (onClear)="resetValueForm('sector')" [autoDisplayFirst]="false" [style]="{width: '100%'}">
          </p-dropdown>
          <label>Sector</label>
        </span>

        <span class="p-float-label w-15rem">
          <p-dropdown [(ngModel)]="offerSearch.type" [options]="types" optionLabel="name" appendTo="body"
            [showClear]="true" formControlName="type" (onClear)="resetValueForm('type')" [autoDisplayFirst]="false" [style]="{width: '100%'}">
          </p-dropdown>
          <label>Tipo</label>
        </span>
      </div>

      <div class="flex flex-row gap-4">

        <span class="p-float-label flex-1">
          <p-autoComplete [suggestions]="groupPerson" [forceSelection]="true" [showEmptyMessage]="true"
            [emptyMessage]="message" (completeMethod)="searchPerson($event)"
            (onSelect)="offerSearch.involved = $event.value" field="field" appendTo="body"
            [showClear]="offerSearch.involved" (onClear)="resetValueForm('involved')" formControlName="involved"
            [style]="{'width':'100%'}" [inputStyle]="{'width':'100%'}">
          </p-autoComplete>
          <label>Persona implicada</label>
        </span>

        <span class="p-float-label flex-1">
          <p-autoComplete [suggestions]="groupPerson" [forceSelection]="true" [showEmptyMessage]="true"
            [emptyMessage]="message" (completeMethod)="searchPerson($event)"
            (onSelect)="offerSearch.managedBy = $event.value" field="field" appendTo="body"
            [showClear]="offerSearch.managedBy" (onClear)="resetValueForm('managedBy')" formControlName="managedBy"
            [style]="{'width':'100%'}" [inputStyle]="{'width':'100%'}">
          </p-autoComplete>
          <label>Responsable CCA</label>
        </span>

        <span class="p-float-label w-15rem">
          <p-multiSelect [(ngModel)]="offerSearch.status" [options]="status" optionLabel="name" appendTo="body"
            [showClear]="true" formControlName="status" (onClear)="filterStatus=[]" [style]="{'width':'100%'}">
          </p-multiSelect>
          <label>Estado</label>
        </span>

        <span class="p-float-label w-15rem">
          <p-calendar [showIcon]="true" [(ngModel)]="offerSearch.deliveryDate" selectionMode="range"
            [readonlyInput]="true" appendTo="body" formControlName="deliveryDate"
            (onClear)="resetValueForm('startDateModification')" [style]="{'width':'100%'}">
          </p-calendar>
          <label>Fecha Entrega Oportunidad</label>
        </span>
      </div>

    </div>
    <div class="align-self-center flex flex-row gap-2">
      <button pButton label="Limpiar" class="p-button-outlined p-button-secondary" [disabled]="!isAssignValuesFilter()"
        (click)="resetForm()"></button>
      <button pButton label="Filtrar" class=" p-button-outlined" [disabled]="filterForm.invalid"
        (click)="loadPage()"></button>
    </div>
  </div>
</div>

<p-table [style]="{'height':'calc(100vh - 240px)'}" [value]="offerItemList" [lazy]="true" (onLazyLoad)="loadPage($event)" [loading]="isloading" scrollable="true"
  scrollHeight="calc(100vh - 310px)" responsiveLayout="scroll" [paginator]="true" [rows]="25"
  [totalRecords]="totalElements" [showCurrentPageReport]="true" [rowsPerPageOptions]="[25, 50, 100]"
  currentPageReportTemplate="{first} - {last} / {totalRecords}" paginatorPosition="bottom"
  [globalFilterFields]="['opportunityStatus.name']" styleClass="p-datatable-striped" selectionMode="single" >
  <ng-template pTemplate="header" >
    <tr>
      <th class="flex-1"  pSortableColumn="name">Nombre Oportunidad
        <p-sortIcon field="name"></p-sortIcon>
      </th>
      <th class="flex-2" pSortableColumn="client">Cliente
        <p-sortIcon field="client"></p-sortIcon>
      </th>
      <th class="flex-none w-10rem" pSortableColumn="sector">Sector
        <p-sortIcon field="sector"></p-sortIcon>
      </th>
      <th class="flex-none w-10rem" pSortableColumn="opportunityType">Tipo
        <p-sortIcon field="opportunityType"></p-sortIcon>
      </th>
      <th class="flex-none w-10rem" pSortableColumn="opportunityStatus">Estado
        <p-sortIcon field="opportunityStatus"></p-sortIcon>
      </th>
      <th class="flex-none w-10rem" pSortableColumn="managedBy">Gestor responsable
        <p-sortIcon field="managedBy"> </p-sortIcon>
      </th>
      <th class="flex-none w-10rem " pSortableColumn="requestedDate">
        F. Solicitud<p-sortIcon field="requestedDate"></p-sortIcon>
      </th>
      <th class="flex-none w-10rem" pSortableColumn="lastModification">
        F. Modificada
        <p-sortIcon field="lastModification"></p-sortIcon>
      </th>
      <th class="flex-none w-10rem">Acci√≥n</th>
    </tr>
    <tr>
      <th class="flex-1">
          <p-columnFilter class="w-full" type="text" field="name" matchMode="contains" [showMenu]="false"></p-columnFilter>
      </th>
      <th class="flex-2" >
          <p-columnFilter class="w-full" type="text" field="client" matchMode="contains" [showMenu]="false"></p-columnFilter>
      </th>
      <th class="flex-none w-10rem">
          <p-columnFilter class="w-full" type="text" field="sector" matchMode="contains" [showMenu]="false"></p-columnFilter>
      </th>
      <th class="flex-none w-10rem">
          <p-columnFilter class="w-full" type="text" field="opportunityType" matchMode="contains" [showMenu]="false"></p-columnFilter>
      </th>        
      <th class="flex-none w-10rem">
        <p-columnFilter class="w-full" type="text" field="opportunityType" matchMode="contains" [showMenu]="false"></p-columnFilter>
      </th> 
      <th class="flex-none w-10rem">
        <p-columnFilter class="w-full" type="text" field="opportunityStatus" matchMode="contains" [showMenu]="false"></p-columnFilter>
      </th> 
      <th class="flex-none w-10rem">
        <p-columnFilter class="w-full" type="text" field="managedBy" matchMode="contains" [showMenu]="false"></p-columnFilter>
      </th> 
      <th class="flex-none w-10rem">
        <p-columnFilter class="w-full" type="text" field="requestedDate" matchMode="contains" [showMenu]="false"></p-columnFilter>
      </th>  
      <th class="flex-none w-10rem">
        <p-columnFilter class="w-full" type="text" field="lastModification" matchMode="contains" [showMenu]="false"></p-columnFilter>
      </th>                         
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-offerItemList>
    <tr>
      <td class="flex-1">{{ offerItemList.name }}</td>
      <td class="flex-2">{{ offerItemList.client}}</td>
      <td class="w-10rem flex-none ">{{
        offerItemList.sector.name }}</td>
      <td class="w-10rem flex-none">{{
        offerItemList.opportunityType.name }}</td>
      <td class="w-10rem flex-none ">{{
        offerItemList.opportunityStatus.name }}</td>
      <td class="w-10rem flex-none ">{{
        transformPerson(offerItemList.managedBy) }}</td>
      <td class="w-10rem flex-none ">{{
        offerItemList.requestedDate | date: "dd/MM/yyyy" }}</td>
      <td class="w-10rem flex-none ">
        {{ offerItemList.lastModification | date: "dd/MM/yyyy hh:mm:ss" }}
      </td>
      <td  class="flex-none w-10rem ">

        <button title="Cambiar estado" *ngIf="canEditOffer(offerItemList)" pButton type="button" icon="pi pi-th-large" (click)="onStatusChange(offerItemList)" class="p-button-rounded p-button-text p-button-plain icon"></button>
        <div *ngIf="!canEditOffer(offerItemList)" style="width:38px"></div>

        <button title="Editar oferta" *ngIf="canEditOffer(offerItemList)" pButton type="button" icon="pi pi-pencil" (click)="onRowSelected(offerItemList)" class="p-button-rounded p-button-text p-button-plain icon"></button>
        <button title="Ver oferta" *ngIf="!canEditOffer(offerItemList)" pButton type="button" icon="pi pi-eye" (click)="onRowSelected(offerItemList)" class="p-button-rounded p-button-text p-button-plain icon"></button>
      </td>
    </tr>
  </ng-template>
  <ng-template pTemplate="paginatorleft"></ng-template>
  <ng-template pTemplate="paginatorright">
    <button pButton id="create-offer" (click)="toOfferEdit()" class="p-button-primary">Nueva oportunidad</button>
  </ng-template>
</p-table>